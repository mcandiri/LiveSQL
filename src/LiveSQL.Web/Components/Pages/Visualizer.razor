@page "/visualizer"
@inject DemoDataService DemoService
@inject IJSRuntime JS

<PageTitle>Visualizer - LiveSQL</PageTitle>

<div class="visualizer-page">
    <!-- Top Bar -->
    <div class="viz-topbar">
        <div class="viz-editor-panel">
            <QueryEditor Sql="@sql" SqlChanged="OnSqlChanged" />
        </div>
        <div class="viz-connection-panel">
            <ConnectionDialog OnConnect="OnConnect" IsConnected="@isConnected" ConnectionName="@connectionName" />
            <button class="btn-analyze" @onclick="OnAnalyze" disabled="@isAnalyzing">
                @if (isAnalyzing)
                {
                    <span class="spinner"></span>
                    <span>Analyzing...</span>
                }
                else
                {
                    <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                    <span>Analyze</span>
                }
            </button>
        </div>
    </div>

    @if (flowData != null)
    {
        <!-- Animation Controls -->
        <div class="viz-controls-bar">
            <AnimationControls OnPlay="OnPlay" OnPause="OnPause" OnStepForward="OnStepForward"
                               OnStepBackward="OnStepBackward" OnShowAll="OnShowAll"
                               Speed="@animSpeed" SpeedChanged="OnSpeedChanged"
                               IsPlaying="@isPlaying" />
        </div>

        <!-- Main Content -->
        <div class="viz-content">
            <div class="viz-diagram-area">
                <FlowDiagram Data="flowData" OnNodeSelected="OnNodeSelected" OnAnimationComplete="OnAnimationDone" @ref="flowDiagramRef" />
            </div>
            <div class="viz-sidebar">
                <MetricsPanel Metrics="@metrics" Nodes="@flowData.Nodes" />

                @if (selectedNode != null)
                {
                    <OperationCard Node="@selectedNode" />
                }

                @if (bottlenecks.Count > 0)
                {
                    <div class="sidebar-section">
                        <h3 class="sidebar-section-title">Bottleneck Alerts</h3>
                        @foreach (var alert in bottlenecks)
                        {
                            <BottleneckAlertCard Alert="@alert" />
                        }
                    </div>
                }

                @if (indexSuggestions.Count > 0)
                {
                    <div class="sidebar-section">
                        <h3 class="sidebar-section-title">Index Suggestions</h3>
                        @foreach (var suggestion in indexSuggestions)
                        {
                            <IndexSuggestion Suggestion="@suggestion" />
                        }
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="viz-empty">
            <div class="viz-empty-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
            </div>
            <h2>Enter a SQL Query</h2>
            <p>Write or paste your SQL query above and click <strong>Analyze</strong> to visualize the execution plan.</p>
            <p class="viz-empty-hint">Or try a <a href="/demo">demo plan</a> to see what LiveSQL can do.</p>
        </div>
    }
</div>

@code {
    private string sql = "SELECT o.OrderId, o.Total, c.Name\nFROM Orders o\nJOIN Customers c ON o.CustomerId = c.Id\nWHERE o.OrderDate > '2024-01-01'\nORDER BY o.Total DESC";
    private bool isAnalyzing;
    private bool isConnected;
    private bool isPlaying;
    private string connectionName = "";
    private double animSpeed = 1.0;
    private FlowDiagramData? flowData;
    private FlowNode? selectedNode;
    private FlowDiagram? flowDiagramRef;
    private DemoPlanMetrics metrics = new();
    private List<BottleneckAlert> bottlenecks = new();
    private List<IndexSuggestionData> indexSuggestions = new();

    private void OnSqlChanged(string newSql) => sql = newSql;

    private void OnConnect(string connString)
    {
        isConnected = !string.IsNullOrWhiteSpace(connString);
        connectionName = isConnected ? "Connected" : "";
    }

    private async Task OnAnalyze()
    {
        isAnalyzing = true;
        StateHasChanged();

        await Task.Delay(800); // Simulate analysis time

        // Use a demo plan for visualization
        flowData = DemoService.BuildFlowDiagram("hash-join");
        var (b, s) = DemoService.GetAnalysis("hash-join");
        bottlenecks = b;
        indexSuggestions = s;
        metrics = new DemoPlanMetrics { TotalCost = 8.72, ElapsedMs = 120, RowsReturned = 45, OperatorCount = 7 };
        selectedNode = null;
        isAnalyzing = false;
        StateHasChanged();
    }

    private void OnNodeSelected(FlowNode node)
    {
        selectedNode = node;
        StateHasChanged();
    }

    private async Task OnPlay()
    {
        isPlaying = true;
        if (flowDiagramRef != null)
            await flowDiagramRef.PlayAnimation(animSpeed);
    }

    private async Task OnPause()
    {
        isPlaying = false;
        if (flowDiagramRef != null)
            await flowDiagramRef.PauseAnimation();
    }

    private async Task OnStepForward()
    {
        if (flowDiagramRef != null)
            await flowDiagramRef.StepForward();
    }

    private async Task OnStepBackward()
    {
        if (flowDiagramRef != null)
            await flowDiagramRef.StepBackward();
    }

    private async Task OnShowAll()
    {
        if (flowDiagramRef != null)
            await flowDiagramRef.ShowAll();
    }

    private void OnAnimationDone()
    {
        isPlaying = false;
        StateHasChanged();
    }

    private void OnSpeedChanged(double speed) => animSpeed = speed;
}
